# CTFCup 2022 | Battles / Main | Pwn

## Название

> heap-plus-plus

## Описание

> Может ли быть уязвимость в таком небольшом количестве кода?
> 
> `nc BEBRABEBRA 17172`

## Раздатка

Участникам нужно выдать файлы:

* [public/heap-plus-plus.tar.gz](public/heap-plus-plus.tar.gz)

## Деплой

```
docker-compose up --build -d
```

## Решение

Основная и единственная уязвимость в том, что аргумент для функции `vector.erase()` никак не проверяется. Соответственно, мы можем передать любое число, в том числе отрицательное. При нужном использовании эта уязвимость даёт нам один примитив -- overlapping chunks, но этот примитив достаточно мощный для дальнейшей эксплуатации.

Краткий план решения такой:

1. Создаём пару чанков и пересекаем их, чтобы слить адрес кучи и токен tcache

2. Снова используем пересечение чанков, но уже для того, чтобы имитировать use-after-free на освобождённых чанках. При помощи этого строим фейковый unsorted bin чанк, освобождаем его и получаем утечку libc.

3. Имея по факту возможность переписывать всю хипу, меняем метаданные чанков, чтобы применить известные атаки на кучу (в авторском решении -- tcache poisoning, но подойдёт любая).

4. С помощью упомянутых выше атак получаем примитив arbitrary write.

5. Осталось придумать что переписать. В авторском решении переписывается GOT библиотеки libstdc++, а именно ссылка на функцию `free()` меняется на `system()`, но тут зависит от фантазии. 

**Пример решения**: [solution/solver.py](solution/solver.py)

## Флаг

```
Cup{697941442c50e13c41f897eea68469d9635983a9e9c61b925ae09d643cb43794}
```
